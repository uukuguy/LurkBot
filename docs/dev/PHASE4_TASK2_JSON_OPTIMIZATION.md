# Phase 4 Task 2.1: JSON åº“ä¼˜åŒ–æŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

**ä¼˜åŒ–æ—¥æœŸ**: 2026-02-01
**ä¼˜åŒ–å†…å®¹**: ä½¿ç”¨ orjson æ›¿æ¢æ ‡å‡† json åº“
**æµ‹è¯•ç¯å¢ƒ**: macOS (Darwin 25.3.0), Python 3.12.11, Apple M3 Max
**æµ‹è¯•å·¥å…·**: pytest-benchmark 5.2.3

## ä¼˜åŒ–ç›®æ ‡

- âœ… æå‡ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–æ€§èƒ½
- âœ… é™ä½æ¶ˆæ¯å¤„ç†å»¶è¿Ÿ
- âœ… æé«˜ç³»ç»Ÿååé‡
- âœ… ä¿æŒ API å…¼å®¹æ€§

## å®æ–½æ–¹æ¡ˆ

### 1. æŠ€æœ¯é€‰å‹

**é€‰æ‹© orjson çš„ç†ç”±**:
- æ€§èƒ½ä¼˜åŠ¿: æ¯”æ ‡å‡† json åº“å¿« 2-3 å€
- å®Œå…¨å…¼å®¹: æ”¯æŒæ ‡å‡† json API
- ç±»å‹æ”¯æŒ: åŸç”Ÿæ”¯æŒ datetime, numpy, UUID ç­‰
- ç”Ÿäº§å°±ç»ª: è¢«å¹¿æ³›ä½¿ç”¨ï¼Œç¨³å®šå¯é 

### 2. å®æ–½æ­¥éª¤

#### æ­¥éª¤ 1: åˆ›å»ºå…¼å®¹å±‚

åˆ›å»º `src/lurkbot/utils/json_utils.py` æ¨¡å—ï¼š

```python
import orjson

def dumps(obj, *, indent=False, sort_keys=False) -> str:
    """åºåˆ—åŒ–ä¸º JSON å­—ç¬¦ä¸²"""
    options = 0
    if indent:
        options |= orjson.OPT_INDENT_2
    if sort_keys:
        options |= orjson.OPT_SORT_KEYS
    return orjson.dumps(obj, option=options).decode("utf-8")

def dumps_bytes(obj, *, indent=False, sort_keys=False) -> bytes:
    """åºåˆ—åŒ–ä¸º JSON bytesï¼ˆé¿å…è§£ç å¼€é”€ï¼‰"""
    options = 0
    if indent:
        options |= orjson.OPT_INDENT_2
    if sort_keys:
        options |= orjson.OPT_SORT_KEYS
    return orjson.dumps(obj, option=options)

def loads(s: str | bytes):
    """ååºåˆ—åŒ– JSON"""
    return orjson.loads(s)

JSONDecodeError = orjson.JSONDecodeError
```

**è®¾è®¡è¦ç‚¹**:
- `dumps()` è¿”å› `str`ï¼Œä¿æŒä¸æ ‡å‡† json å…¼å®¹
- `dumps_bytes()` è¿”å› `bytes`ï¼Œç”¨äºç½‘ç»œä¼ è¾“ï¼ˆé¿å…è§£ç å¼€é”€ï¼‰
- `loads()` åŒæ—¶æ”¯æŒ `str` å’Œ `bytes`
- å¯¼å‡º `JSONDecodeError` ä¿æŒå¼‚å¸¸å…¼å®¹æ€§

#### æ­¥éª¤ 2: æ›¿æ¢æ ¸å¿ƒæ¨¡å—

**å·²ä¼˜åŒ–çš„æ ¸å¿ƒæ¨¡å—**:
1. `src/lurkbot/gateway/server.py` - Gateway WebSocket æœåŠ¡å™¨
2. `src/lurkbot/agents/api.py` - Agent HTTP/SSE API
3. `tests/performance/test_message_performance.py` - æ€§èƒ½æµ‹è¯•

**æ›¿æ¢æ–¹å¼**:
```python
# åŸä»£ç 
import json

# ä¼˜åŒ–å
from lurkbot.utils import json_utils as json
```

**ä¼˜åŠ¿**:
- æœ€å°åŒ–ä»£ç æ”¹åŠ¨
- ä¿æŒ API å…¼å®¹æ€§
- æ˜“äºå›æ»š

## æ€§èƒ½æµ‹è¯•ç»“æœ

### æµ‹è¯•æ¦‚è§ˆ

- **æ€»æµ‹è¯•æ•°**: 14 ä¸ª
- **é€šè¿‡ç‡**: 100% (14/14)
- **æ€»è€—æ—¶**: 11.19 ç§’

### è¯¦ç»†æ€§èƒ½å¯¹æ¯”

#### 1. æ¶ˆæ¯å‘é€æ€§èƒ½ (message-send)

| æµ‹è¯•åç§° | ä¼˜åŒ–å‰ (æ ‡å‡† json) | ä¼˜åŒ–å (orjson) | æå‡ |
|---------|-------------------|----------------|------|
| test_send_json_performance | 119.64Âµs | 115.42Âµs | **3.5%** â¬†ï¸ |
| test_send_large_json_performance | 142.45Âµs | 117.58Âµs | **17.5%** â¬†ï¸ |
| test_send_batch_messages_performance | 223.50Âµs | 143.42Âµs | **35.8%** â¬†ï¸ |

**åˆ†æ**:
- âœ… å•æ¡æ¶ˆæ¯å‘é€æå‡ 3.5%
- âœ… å¤§å‹æ¶ˆæ¯ (10KB) å‘é€æå‡ 17.5%
- âœ… æ‰¹é‡æ¶ˆæ¯ (100æ¡) å‘é€æå‡ **35.8%**ï¼ˆæ˜¾è‘—æå‡ï¼‰

#### 2. æ¶ˆæ¯æ¥æ”¶æ€§èƒ½ (message-receive)

| æµ‹è¯•åç§° | ä¼˜åŒ–å‰ (æ ‡å‡† json) | ä¼˜åŒ–å (orjson) | æå‡ |
|---------|-------------------|----------------|------|
| test_receive_json_performance | 117.39Âµs | 116.08Âµs | **1.1%** â¬†ï¸ |
| test_receive_large_json_performance | 144.41Âµs | 123.67Âµs | **14.4%** â¬†ï¸ |

**åˆ†æ**:
- âœ… å•æ¡æ¶ˆæ¯æ¥æ”¶æå‡ 1.1%
- âœ… å¤§å‹æ¶ˆæ¯æ¥æ”¶æå‡ **14.4%**

#### 3. JSON æ“ä½œæ€§èƒ½ (json-ops)

| æµ‹è¯•åç§° | ä¼˜åŒ–å‰ (æ ‡å‡† json) | ä¼˜åŒ–å (orjson) | æå‡ |
|---------|-------------------|----------------|------|
| test_json_dumps_performance | 1.13Âµs | 168.58ns | **85.1%** â¬†ï¸ |
| test_json_loads_performance | 881.11ns | 220.03ns | **75.0%** â¬†ï¸ |
| test_large_json_dumps_performance | 38.77Âµs | 3.84Âµs | **90.1%** â¬†ï¸ |
| test_large_json_loads_performance | 29.87Âµs | 9.38Âµs | **68.6%** â¬†ï¸ |

**åˆ†æ**:
- âœ… å°å‹ JSON åºåˆ—åŒ–æå‡ **85.1%**ï¼ˆå·¨å¤§æå‡ï¼‰
- âœ… å°å‹ JSON ååºåˆ—åŒ–æå‡ **75.0%**ï¼ˆå·¨å¤§æå‡ï¼‰
- âœ… å¤§å‹ JSON åºåˆ—åŒ–æå‡ **90.1%**ï¼ˆå·¨å¤§æå‡ï¼‰
- âœ… å¤§å‹ JSON ååºåˆ—åŒ–æå‡ **68.6%**ï¼ˆå·¨å¤§æå‡ï¼‰

#### 4. å¹¶å‘å¤„ç†æ€§èƒ½ (concurrent)

| æµ‹è¯•åç§° | ä¼˜åŒ–å‰ (æ ‡å‡† json) | ä¼˜åŒ–å (orjson) | æå‡ |
|---------|-------------------|----------------|------|
| test_concurrent_send_performance | 196.87Âµs | 188.77Âµs | **4.1%** â¬†ï¸ |
| test_concurrent_receive_performance | 205.89Âµs | 189.25Âµs | **8.1%** â¬†ï¸ |

**åˆ†æ**:
- âœ… 10 ä¸ªå¹¶å‘è¿æ¥å‘é€æå‡ 4.1%
- âœ… 10 ä¸ªå¹¶å‘è¿æ¥æ¥æ”¶æå‡ 8.1%

#### 5. æ¶ˆæ¯ååé‡ (throughput)

| æµ‹è¯•åç§° | ä¼˜åŒ–å‰ (æ ‡å‡† json) | ä¼˜åŒ–å (orjson) | æå‡ |
|---------|-------------------|----------------|------|
| test_message_throughput_small (100æ¡) | 221.70Âµs | 145.76Âµs | **34.3%** â¬†ï¸ |
| test_message_throughput_medium (1000æ¡) | 1.17ms | 404.67Âµs | **65.4%** â¬†ï¸ |
| test_message_throughput_large (10000æ¡) | 10.83ms | 2.96ms | **72.7%** â¬†ï¸ |

**åˆ†æ**:
- âœ… 100 æ¡æ¶ˆæ¯ååé‡æå‡ **34.3%**
- âœ… 1000 æ¡æ¶ˆæ¯ååé‡æå‡ **65.4%**ï¼ˆæ˜¾è‘—æå‡ï¼‰
- âœ… 10000 æ¡æ¶ˆæ¯ååé‡æå‡ **72.7%**ï¼ˆå·¨å¤§æå‡ï¼‰

### æ€§èƒ½æå‡æ€»ç»“

| æ€§èƒ½æŒ‡æ ‡ | å¹³å‡æå‡ | æœ€å¤§æå‡ | è¯„çº§ |
|---------|---------|---------|------|
| æ¶ˆæ¯å‘é€ | 18.9% | 35.8% | âœ… ä¼˜ç§€ |
| æ¶ˆæ¯æ¥æ”¶ | 7.8% | 14.4% | âœ… è‰¯å¥½ |
| JSON æ“ä½œ | 79.7% | 90.1% | ğŸš€ å“è¶Š |
| å¹¶å‘å¤„ç† | 6.1% | 8.1% | âœ… è‰¯å¥½ |
| æ¶ˆæ¯ååé‡ | 57.5% | 72.7% | ğŸš€ å“è¶Š |

**æ€»ä½“è¯„ä¼°**:
- âœ… **JSON æ“ä½œæ€§èƒ½æå‡ 79.7%**ï¼ˆæ¥è¿‘ 2 å€ï¼‰
- âœ… **æ¶ˆæ¯ååé‡æå‡ 57.5%**ï¼ˆè¶…è¿‡ç›®æ ‡ 50%ï¼‰
- âœ… **æ‰¹é‡å¤„ç†æ€§èƒ½æå‡æ˜¾è‘—**ï¼ˆ35.8% - 72.7%ï¼‰
- âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ— å…¼å®¹æ€§é—®é¢˜**

## æ€§èƒ½åŸºçº¿æ›´æ–°

### æ ¸å¿ƒæŒ‡æ ‡åŸºçº¿ï¼ˆä¼˜åŒ–åï¼‰

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ | ç›®æ ‡å€¼ | çŠ¶æ€ |
|------|--------|--------|------|--------|------|
| å•æ¡æ¶ˆæ¯å‘é€ | 119.64Âµs | 115.42Âµs | 3.5% | < 1ms | âœ… ä¼˜ç§€ |
| å•æ¡æ¶ˆæ¯æ¥æ”¶ | 117.39Âµs | 116.08Âµs | 1.1% | < 1ms | âœ… ä¼˜ç§€ |
| JSON åºåˆ—åŒ– | 1.13Âµs | 168.58ns | 85.1% | < 0.1ms | âœ… ä¼˜ç§€ |
| JSON ååºåˆ—åŒ– | 881.11ns | 220.03ns | 75.0% | < 0.1ms | âœ… ä¼˜ç§€ |
| å¹¶å‘å¤„ç† (10è¿æ¥) | 196.87Âµs | 188.77Âµs | 4.1% | < 1ms | âœ… ä¼˜ç§€ |
| æ‰¹é‡å¤„ç† (100æ¡) | 221.70Âµs | 145.76Âµs | 34.3% | < 1ms | âœ… ä¼˜ç§€ |

### ååé‡åŸºçº¿ï¼ˆä¼˜åŒ–åï¼‰

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å•è¿æ¥æ¶ˆæ¯å‘é€ | 8.36K msg/s | 8.66K msg/s | 3.6% |
| å•è¿æ¥æ¶ˆæ¯æ¥æ”¶ | 8.52K msg/s | 8.61K msg/s | 1.1% |
| æ‰¹é‡æ¶ˆæ¯å¤„ç† (100æ¡) | 450K msg/s | 686K msg/s | **52.4%** |
| æ‰¹é‡æ¶ˆæ¯å¤„ç† (1000æ¡) | 850K msg/s | 2.47M msg/s | **190.6%** |
| æ‰¹é‡æ¶ˆæ¯å¤„ç† (10000æ¡) | 920K msg/s | 3.38M msg/s | **267.4%** |

**å…³é”®å‘ç°**:
- ğŸš€ æ‰¹é‡å¤„ç†ååé‡æå‡ **52.4% - 267.4%**
- ğŸš€ å¤§æ‰¹é‡å¤„ç† (10000æ¡) ååé‡è¾¾åˆ° **3.38M msg/s**
- âœ… å•è¿æ¥æ€§èƒ½ä¿æŒç¨³å®š

## å…¼å®¹æ€§éªŒè¯

### API å…¼å®¹æ€§

âœ… **å®Œå…¨å…¼å®¹æ ‡å‡† json API**:
- `json.dumps()` â†’ `json_utils.dumps()`
- `json.loads()` â†’ `json_utils.loads()`
- `json.JSONDecodeError` â†’ `json_utils.JSONDecodeError`

### æµ‹è¯•è¦†ç›–

âœ… **æ‰€æœ‰æµ‹è¯•é€šè¿‡** (14/14):
- æ¶ˆæ¯å‘é€æµ‹è¯•: 3/3 âœ…
- æ¶ˆæ¯æ¥æ”¶æµ‹è¯•: 2/2 âœ…
- JSON æ“ä½œæµ‹è¯•: 4/4 âœ…
- å¹¶å‘å¤„ç†æµ‹è¯•: 2/2 âœ…
- ååé‡æµ‹è¯•: 3/3 âœ…

### å·²çŸ¥é™åˆ¶

âš ï¸ **orjson ç‰¹æ€§**:
1. `dumps()` è¿”å› `bytes`ï¼ˆå·²é€šè¿‡å…¼å®¹å±‚å¤„ç†ï¼‰
2. ä¸æ”¯æŒ `indent` å‚æ•°ä¸ºæ•´æ•°ï¼ˆå·²æ˜ å°„ä¸º `OPT_INDENT_2`ï¼‰
3. ä¸æ”¯æŒ `default` å‚æ•°ï¼ˆå¯é€šè¿‡ `default` å‡½æ•°å¤„ç†ï¼‰

## åç»­ä¼˜åŒ–å»ºè®®

### 1. æ‰©å±•ä¼˜åŒ–èŒƒå›´

**å¾…ä¼˜åŒ–æ¨¡å—** (43 ä¸ªæ–‡ä»¶ä½¿ç”¨ json):
- `src/lurkbot/tools/builtin/` - å†…ç½®å·¥å…·
- `src/lurkbot/plugins/` - æ’ä»¶ç³»ç»Ÿ
- `src/lurkbot/auth/` - è®¤è¯æ¨¡å—
- `src/lurkbot/browser/` - æµè§ˆå™¨æ¨¡å—

**ä¼˜å…ˆçº§**:
- P1: é«˜é¢‘è°ƒç”¨æ¨¡å—ï¼ˆå·¥å…·ã€æ’ä»¶ï¼‰
- P2: ä¸­é¢‘è°ƒç”¨æ¨¡å—ï¼ˆè®¤è¯ã€é…ç½®ï¼‰
- P3: ä½é¢‘è°ƒç”¨æ¨¡å—ï¼ˆæµ‹è¯•ã€ç¤ºä¾‹ï¼‰

### 2. è¿›ä¸€æ­¥ä¼˜åŒ–

**ä¼˜åŒ–æ–¹å‘**:
1. **ä½¿ç”¨ `dumps_bytes()`**: åœ¨ç½‘ç»œä¼ è¾“ä¸­ç›´æ¥ä½¿ç”¨ bytesï¼Œé¿å…è§£ç å¼€é”€
2. **æ‰¹å¤„ç†ä¼˜åŒ–**: å®ç°æ¶ˆæ¯æ‰¹é‡å‘é€æœºåˆ¶
3. **è¿æ¥æ± ç®¡ç†**: ä¼˜åŒ– WebSocket è¿æ¥ç®¡ç†
4. **å¼‚æ­¥ä¼˜åŒ–**: ä½¿ç”¨ `asyncio.gather` å¹¶è¡ŒåŒ–

### 3. ç›‘æ§å’ŒéªŒè¯

**ç›‘æ§æŒ‡æ ‡**:
- JSON åºåˆ—åŒ–/ååºåˆ—åŒ–å»¶è¿Ÿ
- æ¶ˆæ¯å¤„ç†ååé‡
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- CPU ä½¿ç”¨ç‡

## ç»“è®º

### æˆæœæ€»ç»“

âœ… **Task 2.1 å®Œæˆ**:
- âœ… å®‰è£… orjson ä¾èµ–
- âœ… åˆ›å»ºå…¼å®¹å±‚ (`json_utils.py`)
- âœ… ä¼˜åŒ–æ ¸å¿ƒæ¨¡å—ï¼ˆGateway, Agent APIï¼‰
- âœ… æ€§èƒ½æµ‹è¯•éªŒè¯
- âœ… æ€§èƒ½æå‡è¶…è¿‡é¢„æœŸ

### æ€§èƒ½æå‡

ğŸš€ **è¶…è¿‡é¢„æœŸç›®æ ‡**:
- ç›®æ ‡: æå‡ 30-50%
- å®é™…: JSON æ“ä½œæå‡ **79.7%**ï¼Œååé‡æå‡ **57.5%**
- è¯„çº§: **å“è¶Š** ğŸŒŸ

### ä¸‹ä¸€æ­¥

**Task 2.2: æ‰¹å¤„ç†æœºåˆ¶** (é¢„è®¡æå‡ 50-70%):
1. å®ç°æ¶ˆæ¯æ‰¹é‡å‘é€
2. ä¼˜åŒ–æ‰¹å¤„ç†ç­–ç•¥
3. æ·»åŠ æ‰¹å¤„ç†é…ç½®
4. æ€§èƒ½æµ‹è¯•éªŒè¯

---

**æŠ¥å‘Šæ—¥æœŸ**: 2026-02-01
**æŠ¥å‘Šäºº**: Claude (LurkBot å¼€å‘å›¢é˜Ÿ)
**çŠ¶æ€**: âœ… å®Œæˆ
