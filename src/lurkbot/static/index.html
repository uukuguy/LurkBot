<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LurkBot Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <style>
        .chat-message {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .typing-indicator span {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">LurkBot Dashboard</h1>
            <p class="text-gray-600">Multi-channel AI Assistant Platform</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Sessions & Models -->
            <div class="space-y-6">

                <!-- Sessions Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Sessions</h2>
                        <button
                            onclick="loadSessions()"
                            class="text-blue-600 hover:text-blue-800 text-sm">
                            Refresh
                        </button>
                    </div>
                    <div id="sessions-list" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading sessions...</p>
                    </div>
                </div>

                <!-- Models Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">Available Models</h2>
                    <div id="models-list" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading models...</p>
                    </div>
                    <div class="mt-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Selected Model
                        </label>
                        <select
                            id="model-select"
                            class="w-full p-2 border rounded-md bg-white">
                            <option value="">Default</option>
                        </select>
                    </div>
                </div>

                <!-- Approvals Card -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">Pending Approvals</h2>
                        <span id="approval-count" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full hidden">0</span>
                    </div>
                    <div id="approvals-list" class="space-y-2">
                        <p class="text-gray-500 text-sm">No pending approvals</p>
                    </div>
                </div>

            </div>

            <!-- Right Column: Chat Interface -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-lg shadow-md h-full flex flex-col">

                    <!-- Chat Header -->
                    <div class="p-4 border-b flex justify-between items-center">
                        <div>
                            <h2 class="text-xl font-semibold">Chat</h2>
                            <p id="current-session" class="text-sm text-gray-500">Session: web_default</p>
                        </div>
                        <div class="flex space-x-2">
                            <input
                                type="text"
                                id="session-input"
                                value="web_default"
                                class="px-3 py-1 border rounded-md text-sm w-40"
                                placeholder="Session ID">
                            <button
                                onclick="clearChat()"
                                class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded-md text-sm">
                                Clear
                            </button>
                        </div>
                    </div>

                    <!-- Chat Messages -->
                    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 min-h-96 max-h-[500px]">
                        <p class="text-gray-500 text-center">Start a conversation...</p>
                    </div>

                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="px-4 pb-2 hidden">
                        <div class="typing-indicator flex space-x-1">
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                            <span class="w-2 h-2 bg-gray-400 rounded-full"></span>
                        </div>
                    </div>

                    <!-- Chat Input -->
                    <div class="p-4 border-t">
                        <form onsubmit="sendMessage(event)" class="flex space-x-2">
                            <input
                                type="text"
                                id="message-input"
                                class="flex-1 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                placeholder="Type your message...">
                            <button
                                type="submit"
                                id="send-button"
                                class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50">
                                Send
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>LurkBot v0.1.0 | <span id="connection-status" class="text-gray-400">Connecting...</span></p>
        </footer>
    </div>

    <script>
        const API_BASE = '';
        let ws = null;
        let currentSession = 'web_default';
        let messageHistory = [];

        // Safe HTML helper using DOMPurify
        function sanitize(text) {
            return DOMPurify.sanitize(text);
        }

        // Create element safely
        function createElement(tag, className, textContent) {
            const el = document.createElement(tag);
            if (className) el.className = className;
            if (textContent) el.textContent = textContent;
            return el;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSessions();
            loadModels();
            loadApprovals();
            connectWebSocket();

            // Update session display
            document.getElementById('session-input').addEventListener('change', (e) => {
                currentSession = e.target.value;
                document.getElementById('current-session').textContent = 'Session: ' + currentSession;
            });
        });

        // WebSocket Connection
        function connectWebSocket() {
            const clientId = 'dashboard-' + Date.now();
            const wsUrl = 'ws://' + window.location.host + '/ws/chat/' + clientId;

            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                document.getElementById('connection-status').textContent = 'Connected';
                document.getElementById('connection-status').className = 'text-green-500';
            };

            ws.onclose = () => {
                document.getElementById('connection-status').textContent = 'Disconnected';
                document.getElementById('connection-status').className = 'text-red-500';
                // Reconnect after 3 seconds
                setTimeout(connectWebSocket, 3000);
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'chat_start':
                    document.getElementById('typing-indicator').classList.remove('hidden');
                    break;

                case 'chat_chunk':
                    appendToLastMessage(data.data.content);
                    break;

                case 'chat_end':
                    document.getElementById('typing-indicator').classList.add('hidden');
                    document.getElementById('send-button').disabled = false;
                    break;

                case 'chat_error':
                    document.getElementById('typing-indicator').classList.add('hidden');
                    document.getElementById('send-button').disabled = false;
                    addMessage('assistant', 'Error: ' + data.data.error, true);
                    break;

                case 'approval_required':
                    loadApprovals();
                    break;
            }
        }

        // Load Sessions
        async function loadSessions() {
            try {
                const response = await fetch(API_BASE + '/api/sessions');
                const data = await response.json();

                const container = document.getElementById('sessions-list');
                container.textContent = '';

                if (data.sessions.length === 0) {
                    container.appendChild(createElement('p', 'text-gray-500 text-sm', 'No active sessions'));
                    return;
                }

                data.sessions.forEach(s => {
                    const sessionDiv = createElement('div', 'flex justify-between items-center p-2 bg-gray-50 rounded hover:bg-gray-100 cursor-pointer');
                    sessionDiv.onclick = () => selectSession(s.session_id);

                    const infoDiv = createElement('div');
                    const nameP = createElement('p', 'font-medium text-sm', s.session_id);
                    const countP = createElement('p', 'text-xs text-gray-500', s.message_count + ' messages');
                    infoDiv.appendChild(nameP);
                    infoDiv.appendChild(countP);

                    const deleteBtn = createElement('button', 'text-red-500 hover:text-red-700 text-xs', 'Delete');
                    deleteBtn.onclick = (e) => {
                        e.stopPropagation();
                        deleteSession(s.session_id);
                    };

                    sessionDiv.appendChild(infoDiv);
                    sessionDiv.appendChild(deleteBtn);
                    container.appendChild(sessionDiv);
                });
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        function selectSession(sessionId) {
            currentSession = sessionId;
            document.getElementById('session-input').value = sessionId;
            document.getElementById('current-session').textContent = 'Session: ' + sessionId;
            loadSessionHistory(sessionId);
        }

        async function loadSessionHistory(sessionId) {
            try {
                const response = await fetch(API_BASE + '/api/sessions/' + sessionId);
                const data = await response.json();

                const container = document.getElementById('chat-messages');
                container.textContent = '';

                data.messages.forEach(m => {
                    addMessage(m.role, m.content);
                });
            } catch (error) {
                console.error('Failed to load session history:', error);
            }
        }

        async function deleteSession(sessionId) {
            if (!confirm('Delete session ' + sessionId + '?')) return;

            try {
                await fetch(API_BASE + '/api/sessions/' + sessionId, { method: 'DELETE' });
                loadSessions();
            } catch (error) {
                console.error('Failed to delete session:', error);
            }
        }

        // Load Models
        async function loadModels() {
            try {
                const response = await fetch(API_BASE + '/api/models');
                const data = await response.json();

                const container = document.getElementById('models-list');
                const select = document.getElementById('model-select');

                container.textContent = '';
                data.models.forEach(m => {
                    const modelDiv = createElement('div', 'p-2 bg-gray-50 rounded text-sm');
                    const nameP = createElement('p', 'font-medium', m.name);
                    const detailP = createElement('p', 'text-xs text-gray-500', m.provider + ' Â· ' + m.api_type);
                    modelDiv.appendChild(nameP);
                    modelDiv.appendChild(detailP);
                    container.appendChild(modelDiv);
                });

                // Clear and rebuild select
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                data.models.forEach(m => {
                    const option = createElement('option', '', m.name);
                    option.value = m.id;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Failed to load models:', error);
            }
        }

        // Load Approvals
        async function loadApprovals() {
            try {
                const response = await fetch(API_BASE + '/api/approvals');
                const data = await response.json();

                const container = document.getElementById('approvals-list');
                const badge = document.getElementById('approval-count');

                container.textContent = '';

                if (data.total === 0) {
                    container.appendChild(createElement('p', 'text-gray-500 text-sm', 'No pending approvals'));
                    badge.classList.add('hidden');
                    return;
                }

                badge.textContent = data.total;
                badge.classList.remove('hidden');

                data.approvals.forEach(a => {
                    const approvalDiv = createElement('div', 'p-3 bg-yellow-50 border border-yellow-200 rounded');

                    const nameP = createElement('p', 'font-medium text-sm', a.tool_name);
                    approvalDiv.appendChild(nameP);

                    if (a.command) {
                        const cmdP = createElement('p', 'text-xs text-gray-600 font-mono', a.command);
                        approvalDiv.appendChild(cmdP);
                    }

                    const btnDiv = createElement('div', 'mt-2 flex space-x-2');

                    const approveBtn = createElement('button', 'px-3 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600', 'Approve');
                    approveBtn.onclick = () => resolveApproval(a.id, 'approve');

                    const denyBtn = createElement('button', 'px-3 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600', 'Deny');
                    denyBtn.onclick = () => resolveApproval(a.id, 'deny');

                    btnDiv.appendChild(approveBtn);
                    btnDiv.appendChild(denyBtn);
                    approvalDiv.appendChild(btnDiv);

                    container.appendChild(approvalDiv);
                });
            } catch (error) {
                console.error('Failed to load approvals:', error);
            }
        }

        async function resolveApproval(id, action) {
            try {
                await fetch(API_BASE + '/api/approvals/' + id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: action })
                });
                loadApprovals();
            } catch (error) {
                console.error('Failed to resolve approval:', error);
            }
        }

        // Chat Functions
        function sendMessage(event) {
            event.preventDefault();

            const input = document.getElementById('message-input');
            const message = input.value.trim();

            if (!message) return;

            // Add user message to chat
            addMessage('user', message);
            input.value = '';

            // Add empty assistant message for streaming
            addMessage('assistant', '', false, true);

            // Disable send button
            document.getElementById('send-button').disabled = true;

            // Get selected model
            const model = document.getElementById('model-select').value || null;

            // Send via WebSocket
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'chat',
                    data: {
                        session_id: currentSession,
                        message: message,
                        model: model
                    }
                }));
            } else {
                // Fallback to HTTP
                sendMessageHTTP(message, model);
            }
        }

        async function sendMessageHTTP(message, model) {
            try {
                const response = await fetch(API_BASE + '/api/sessions/' + currentSession + '/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: message, model: model, stream: false })
                });

                const data = await response.json();

                // Update the streaming placeholder with full response
                const messages = document.getElementById('chat-messages');
                const lastMessage = messages.lastElementChild;
                if (lastMessage && lastMessage.dataset.streaming) {
                    const contentEl = lastMessage.querySelector('.message-content');
                    contentEl.textContent = data.response;
                    delete lastMessage.dataset.streaming;
                }

                document.getElementById('typing-indicator').classList.add('hidden');
                document.getElementById('send-button').disabled = false;

            } catch (error) {
                console.error('Failed to send message:', error);
                document.getElementById('send-button').disabled = false;
            }
        }

        function addMessage(role, content, isError, isStreaming) {
            const container = document.getElementById('chat-messages');

            // Remove placeholder text if present
            if (container.children.length === 1 && container.firstChild.textContent === 'Start a conversation...') {
                container.textContent = '';
            }

            const isUser = role === 'user';
            const bgColor = isUser ? 'bg-blue-100' : (isError ? 'bg-red-100' : 'bg-gray-100');
            const alignment = isUser ? 'ml-auto' : 'mr-auto';

            const messageDiv = createElement('div', 'chat-message max-w-[80%] ' + alignment);
            if (isStreaming) messageDiv.dataset.streaming = 'true';

            const bubbleDiv = createElement('div', bgColor + ' rounded-lg p-3');
            const labelP = createElement('p', 'text-xs text-gray-500 mb-1', isUser ? 'You' : 'Assistant');
            const contentP = createElement('p', 'message-content whitespace-pre-wrap', content);

            bubbleDiv.appendChild(labelP);
            bubbleDiv.appendChild(contentP);
            messageDiv.appendChild(bubbleDiv);

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function appendToLastMessage(content) {
            const messages = document.getElementById('chat-messages');
            const lastMessage = messages.lastElementChild;

            if (lastMessage && lastMessage.dataset.streaming) {
                const contentEl = lastMessage.querySelector('.message-content');
                contentEl.textContent += content;
                messages.scrollTop = messages.scrollHeight;
            }
        }

        function clearChat() {
            const container = document.getElementById('chat-messages');
            container.textContent = '';
            container.appendChild(createElement('p', 'text-gray-500 text-center', 'Start a conversation...'));
        }

        // Refresh approvals periodically
        setInterval(loadApprovals, 10000);
    </script>
</body>
</html>
